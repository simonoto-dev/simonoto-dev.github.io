<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Groove Oracle">
<meta name="theme-color" content="#08070d">
<title>Groove Oracle</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,700;9..144,900&display=swap" rel="stylesheet">
<style>
:root{--bg:#08070d;--s:#110f18;--s2:#1d1c24;--bd:#2a2838;--acc:#d4943a;--gold:#fbbf24;--prp:#a78bfa;--pnk:#f472b6;--cyn:#22d3ee;--grn:#4ade80;--red:#f87171;--txt:#e8e8ef;--mut:#7a7890;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:env(safe-area-inset-top,0) 0 env(safe-area-inset-bottom,0);}
.wrap{max-width:500px;margin:0 auto;padding:24px 20px;}
h1{font-family:'Fraunces',Georgia,serif;font-size:2.2rem;font-weight:900;text-align:center;margin:0;
  background:linear-gradient(135deg,var(--acc),var(--gold),var(--pnk));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.sub{text-align:center;color:var(--mut);font-size:12px;margin:4px 0 16px;}
canvas{width:100%;height:160px;border-radius:12px;display:block;margin-bottom:16px;touch-action:none;}
.cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.card{background:var(--s);border:1px solid var(--bd);border-radius:12px;padding:14px 16px;cursor:pointer;
  transition:transform 0.2s,box-shadow 0.2s;min-height:140px;display:flex;flex-direction:column;-webkit-user-select:none;user-select:none;}
.card:active{transform:scale(0.97);}
.card-head{display:flex;align-items:center;gap:6px;margin-bottom:8px;}
.card-icon{font-size:18px;}
.card-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;}
.card-body{flex:1;font-size:13px;font-weight:600;line-height:1.4;}
.card-foot{font-size:10px;color:var(--mut);text-align:center;margin-top:6px;}
.card-meta{display:flex;gap:10px;font-size:11px;margin-top:4px;}
.affirm{margin:0 0 14px;padding:16px;text-align:center;cursor:pointer;
  background:linear-gradient(135deg,rgba(212,148,58,0.08),rgba(167,139,250,0.04));
  border:1px solid var(--bd);border-radius:12px;-webkit-user-select:none;user-select:none;}
.affirm-label{font-size:9px;color:var(--acc);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:4px;}
.affirm-text{font-family:'Fraunces',Georgia,serif;font-size:15px;font-weight:700;line-height:1.5;}
.oracle-btn{display:block;width:100%;padding:14px;border:none;border-radius:14px;font-size:16px;font-weight:800;
  cursor:pointer;letter-spacing:0.5px;transition:transform 0.2s;
  background:linear-gradient(135deg,var(--acc),var(--gold));color:#000;}
.oracle-btn:active{transform:scale(0.96);}
.rolls{text-align:center;color:var(--mut);font-size:11px;margin-top:6px;}
.groove-btn{position:absolute;bottom:10px;right:10px;padding:5px 12px;border-radius:16px;font-size:11px;font-weight:600;
  cursor:pointer;border:1px solid var(--bd);background:var(--s);color:var(--mut);transition:all 0.3s;}
.groove-btn.on{background:var(--acc);color:#000;border-color:var(--acc);}
.viz-wrap{position:relative;margin-bottom:16px;}
.foot{text-align:center;color:var(--mut);font-size:10px;margin-top:16px;padding-bottom:20px;}
.fav-btn{position:absolute;top:8px;right:8px;background:none;border:none;font-size:16px;cursor:pointer;opacity:0.4;transition:opacity 0.2s,transform 0.2s;padding:4px;z-index:2;}
.fav-btn:hover,.fav-btn.saved{opacity:1;}
.fav-btn.saved{transform:scale(1.1);}
.card{position:relative;}
.favs-section{margin:14px 0;background:var(--s);border:1px solid var(--bd);border-radius:12px;overflow:hidden;}
.favs-toggle{width:100%;padding:10px 16px;background:none;border:none;color:var(--acc);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;cursor:pointer;display:flex;align-items:center;gap:6px;}
.favs-toggle .arrow{transition:transform 0.2s;font-size:10px;}
.favs-toggle .arrow.open{transform:rotate(90deg);}
.favs-list{padding:0 14px 12px;display:flex;flex-direction:column;gap:6px;}
.fav-item{display:flex;align-items:flex-start;gap:8px;padding:8px 10px;background:var(--s2);border:1px solid var(--bd);border-radius:8px;font-size:12px;line-height:1.4;}
.fav-item-type{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;flex-shrink:0;padding:2px 6px;border-radius:4px;}
.fav-item-text{flex:1;min-width:0;}
.fav-item-del{background:none;border:none;color:var(--mut);cursor:pointer;font-size:14px;padding:0 2px;flex-shrink:0;opacity:0.5;}
.fav-item-del:hover{opacity:1;color:var(--red);}
</style>
</head>
<body>
<div id="auth-gate" style="display:flex;align-items:center;justify-content:center;height:100vh;background:#08070d;">
<div style="text-align:center;padding:40px;">
<div style="font-size:40px;margin-bottom:16px;">üîÆ</div>
<div style="font-family:'Fraunces',Georgia,serif;font-size:24px;background:linear-gradient(135deg,#d4943a,#fbbf24,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;">Groove Oracle</div>
<div style="color:#7a7890;font-size:12px;margin-bottom:24px;">Private Access</div>
<input id="auth-pw" type="password" placeholder="Enter password" style="width:240px;padding:10px 16px;border-radius:10px;border:1px solid #2a2838;background:#110f18;color:#e8e8ef;font-size:14px;text-align:center;outline:none;" onkeydown="if(event.key==='Enter')checkAuth()">
<br><button onclick="checkAuth()" style="margin-top:12px;padding:8px 32px;border-radius:10px;border:none;background:linear-gradient(135deg,#d4943a,#fbbf24);color:#000;font-weight:600;font-size:14px;cursor:pointer;">Enter</button>
<div id="auth-err" style="color:#f87171;font-size:12px;margin-top:10px;display:none;">Incorrect password</div>
</div>
</div>
<div class="wrap" id="main-app" style="display:none;">
  <p style="text-align:center;font-size:10px;color:var(--acc);text-transform:uppercase;letter-spacing:2px;font-weight:700;margin-bottom:2px;">The Simonoto</p>
  <h1>Groove Oracle</h1>
  <div class="sub" id="greeting"></div>
  <div class="viz-wrap">
    <canvas id="viz" width="500" height="160"></canvas>
    <button class="groove-btn" id="groove-toggle" onclick="toggleGroove()">‚ñ∂ Activate</button>
  </div>
  <div class="cards">
    <div class="card" style="border-top:3px solid var(--acc)" onclick="roll('practice')">
      <button class="fav-btn" id="fav-practice" onclick="event.stopPropagation();toggleFav('practice')" title="Save to favorites">‚òÜ</button>
      <div class="card-head"><span class="card-icon">üé∏</span><span class="card-title" style="color:var(--acc)">Practice</span></div>
      <div class="card-body" id="practice-text"></div>
      <div class="card-meta" id="practice-meta"></div>
      <div class="card-foot">tap to reroll</div>
    </div>
    <div class="card" style="border-top:3px solid var(--prp)" onclick="roll('content')">
      <button class="fav-btn" id="fav-content" onclick="event.stopPropagation();toggleFav('content')" title="Save to favorites">‚òÜ</button>
      <div class="card-head"><span class="card-icon">üì±</span><span class="card-title" style="color:var(--prp)">Content</span></div>
      <div class="card-body" id="content-text"></div>
      <div class="card-foot">tap to reroll</div>
    </div>
    <div class="card" style="border-top:3px solid var(--cyn)" onclick="roll('collab')">
      <button class="fav-btn" id="fav-collab" onclick="event.stopPropagation();toggleFav('collab')" title="Save to favorites">‚òÜ</button>
      <div class="card-head"><span class="card-icon">ü§ù</span><span class="card-title" style="color:var(--cyn)">Collab</span></div>
      <div class="card-body" id="collab-text"></div>
      <div class="card-foot">tap to reroll</div>
    </div>
    <div class="card" style="border-top:3px solid var(--pnk)" onclick="roll('wild')">
      <button class="fav-btn" id="fav-wild" onclick="event.stopPropagation();toggleFav('wild')" title="Save to favorites">‚òÜ</button>
      <div class="card-head"><span class="card-icon">üé≤</span><span class="card-title" style="color:var(--pnk)">Wild Card</span></div>
      <div class="card-body" id="wild-text"></div>
      <div class="card-foot">tap to reroll</div>
    </div>
  </div>
  <div class="favs-section" id="favs-section" style="display:none;">
    <button class="favs-toggle" onclick="toggleFavsPanel()"><span class="arrow" id="favs-arrow">‚ñ∂</span> Saved Grooves (<span id="favs-count">0</span>)</button>
    <div class="favs-list" id="favs-list" style="display:none;"></div>
  </div>
  <div class="affirm" onclick="roll('affirm')">
    <div class="affirm-label">‚ú® Daily Affirmation (tap to refresh)</div>
    <div class="affirm-text" id="affirm-text"></div>
  </div>
  <button class="oracle-btn" onclick="rollAll()">üîÆ Consult the Oracle Again</button>
  <div class="rolls" id="roll-count"></div>
  <div class="foot">The groove is the message. Now go make something. üéµ</div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const AUTH_KEY='simonoto-go-auth';
const PW_HASH='49c23c06';
function simpleHash(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return Math.abs(h).toString(16).slice(0,12);}
function checkAuth(){
  const pw=document.getElementById('auth-pw').value;
  if(simpleHash(pw)===PW_HASH){sessionStorage.setItem(AUTH_KEY,'1');showApp();}
  else{document.getElementById('auth-err').style.display='block';}
}
function showApp(){document.getElementById('auth-gate').style.display='none';document.getElementById('main-app').style.display='block';}
if(sessionStorage.getItem(AUTH_KEY)==='1')showApp();
const P=[
  {c:"Play your fav Ch.1 track on a different instrument.",d:"üå∂Ô∏èüå∂Ô∏è",t:"20m"},
  {c:"Learn a Herbie Hancock voicing ‚Üí 3 progressions.",d:"üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è",t:"45m"},
  {c:"Record a 60-second loop with only body percussion.",d:"üå∂Ô∏è",t:"15m"},
  {c:"Transcribe a bass line by ear. Play it on guitar.",d:"üå∂Ô∏èüå∂Ô∏è",t:"30m"},
  {c:"10 min: improvise over a drone in an unfamiliar key.",d:"üå∂Ô∏è",t:"10m"},
  {c:"Write a melody using only 4 notes. Make it stick.",d:"üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è",t:"25m"},
  {c:"Play along to a genre you NEVER listen to.",d:"üå∂Ô∏èüå∂Ô∏è",t:"20m"},
  {c:"Record yourself. Listen back. What surprised you?",d:"üå∂Ô∏è",t:"15m"},
  {c:"Practice one song at HALF tempo. Feel every note.",d:"üå∂Ô∏èüå∂Ô∏è",t:"15m"},
  {c:"Create a beat in Reaper using only kitchen sounds.",d:"üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è",t:"40m"},
  {c:"Play a chord progression eyes closed. Pure feel.",d:"üå∂Ô∏è",t:"10m"},
  {c:"Learn the bridge of a standard you've been avoiding.",d:"üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è",t:"30m"},
  {c:"Take a BellDingThing riff ‚Üí modulate through 3 keys.",d:"üå∂Ô∏èüå∂Ô∏è",t:"20m"},
  {c:"Play along to Sly Stone. Absorb the pocket.",d:"üå∂Ô∏èüå∂Ô∏è",t:"25m"},
  {c:"Compose a 16-bar piece about how you feel RIGHT NOW.",d:"üå∂Ô∏èüå∂Ô∏è",t:"20m"},
  {c:"Listen to Tynomite! ‚Äî write 3 things you'd change. Then DON'T.",d:"üå∂Ô∏è",t:"15m"},
  {c:"Play only whole notes for 5 minutes. Every one counts.",d:"üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è",t:"5m"},
  {c:"Learn a D'Angelo guitar part by ear. No tabs.",d:"üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è",t:"45m"},
  {c:"Record a 1-min improv. Send it to someone you respect.",d:"üå∂Ô∏èüå∂Ô∏è",t:"10m"},
];
const CN=[
  "Film a 15-sec clip of the weirdest sound your gear makes.",
  "Post a 'what I'm listening to' story with a snippet.",
  "Record yourself teaching a groove concept. Professor of Funk energy.",
  "Show your pedalboard/gear with a quick caption.",
  "Film before/after: rough demo vs. polished mix. 30 seconds.",
  "Post a 'studio view' photo. Real > perfect.",
  "Record a reaction to a song you love. Pure enthusiasm.",
  "Share a chord voicing your students struggle with.",
  "Film yourself playing along to whatever's on shuffle.",
  "Post what inspired you today. A building, color, conversation.",
  "One-take performance. No edits. Imperfection = charm.",
  "Share a music hot take. Start a conversation.",
  "Film Oakland from your studio. Set to your music.",
  "30-second story about why you started playing.",
  "Post your practice space. Where the magic happens.",
];
const AF=[
  "You have 4 completed tracks ready. More than most achieve in a year.",
  "Jazz degree + production chops + teaching = nobody sounds like you.",
  "6 months of weekly releases from what you already have.",
  "Professor of Funk at $200/hr proves your value.",
  "The groove is the message. When you play, people feel it.",
  "Tiny Telephone. Hyde Street. You belong in any room.",
  "Chapter 1 exists because you had vision AND discipline.",
  "One session closer to the player you want to become.",
  "Your community supports you. The Bay knows your name.",
  "The Otis method works. The site is live. You're ready.",
  "Progress over perfection. Ship it. Let the music breathe.",
  "Musician, producer, engineer, educator, entrepreneur. That's powerful.",
];
const CL=[
  {i:"Commission a local visual artist for a music video.",e:"üíú"},
  {i:"Find an Oakland poet. Spoken word over your instrumental.",e:"üíõ"},
  {i:"Hit up a coffee shop about monthly acoustic sets.",e:"üíö"},
  {i:"Text Julian RIGHT NOW about the Freeze session.",e:"üî•"},
  {i:"Ask your wife to photograph your next practice session.",e:"üíõ"},
  {i:"Find a CJC drummer. Record a raw duo jam.",e:"üíö"},
  {i:"Pitch a Bay Area music blogger your story.",e:"üíú"},
  {i:"Invite Victor Ko for a Data.Mosh session.",e:"üî•"},
  {i:"Organize a Celestial Hotties jam. Film everything.",e:"üíõ"},
  {i:"Reach out to KQED about a music education segment.",e:"üíú"},
];
const WC=[
  "üé≤ Go to a record store. Buy the first album that catches your eye.",
  "üé≤ Write a song in a genre you've never tried. 30 minutes.",
  "üé≤ Call someone who inspired your music journey. Tell them.",
  "üé≤ Walk without headphones. What rhythms does the city have?",
  "üé≤ Cook a meal while listening to your own music.",
  "üé≤ Rearrange your studio. Even one thing changes perspective.",
  "üé≤ Write a letter to Simonoto one year from now.",
  "üé≤ Learn a Pok√©mon battle theme on guitar. Then funk it up.",
  "üé≤ Find an old recording of yourself. Marvel at how far you've come.",
  "üé≤ Go busking. Just you and a guitar. See what happens.",
];
/* ===== FIREBASE SETUP ===== */
const firebaseConfig={
  apiKey:"AIzaSyD66hIkYuZqPILjVruz0lnAqfrEK29PGog",
  authDomain:"simonoto-828c0.firebaseapp.com",
  databaseURL:"https://simonoto-828c0-default-rtdb.firebaseio.com",
  projectId:"simonoto-828c0",
  storageBucket:"simonoto-828c0.firebasestorage.app",
  messagingSenderId:"578067799039",
  appId:"1:578067799039:web:e43aede4916da472bd25ca"
};
const fbApp=firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously().catch(e=>console.warn("Anon auth failed",e));
const fbDb=firebase.database();
const DB_ROOT="groove-oracle";
function dbRef(path){return fbDb.ref(DB_ROOT+"/"+path)}
let skipSync=false;

async function fbLoad(key,fallback){
  try{const snap=await dbRef(key).once("value");const val=snap.val();return val!==null?val:fallback;}
  catch(e){console.warn("Firebase read failed",e);try{const r=localStorage.getItem("go-"+key);return r?JSON.parse(r):fallback;}catch(e2){return fallback;}}
}
async function fbSave(key,val){
  try{await dbRef(key).set(val);}catch(e){console.warn("Firebase write failed",e);}
  try{localStorage.setItem("go-"+key,JSON.stringify(val));}catch(e){}
}
function onDataChange(key,callback){
  const ref=dbRef(key);
  ref.on("value",snap=>{const val=snap.val();if(val!==null&&!skipSync)callback(val);});
  return()=>ref.off("value");
}

/* ===== STATE ===== */
function rand(a){return a[Math.floor(Math.random()*a.length)];}
let rolls=0,totalRolls=0,grooveOn=false;
let favorites=[]; // [{type,text}]
let currentCards={practice:"",content:"",collab:"",wild:"",affirm:""};
const TYPE_COLORS={practice:"var(--acc)",content:"var(--prp)",collab:"var(--cyn)",wild:"var(--pnk)",affirm:"var(--gold)"};
const TYPE_ICONS={practice:"üé∏",content:"üì±",collab:"ü§ù",wild:"üé≤",affirm:"‚ú®"};

function roll(type){
  let text="";
  if(type==="practice"){const p=rand(P);text=p.c;document.getElementById("practice-text").textContent=p.c;document.getElementById("practice-meta").innerHTML='<span style="color:var(--red)">'+p.d+'</span><span style="color:var(--mut)">‚è± '+p.t+'</span>';}
  if(type==="content"){text=rand(CN);document.getElementById("content-text").textContent=text;}
  if(type==="collab"){const c=rand(CL);text=c.i+" "+c.e;document.getElementById("collab-text").textContent=text;}
  if(type==="wild"){text=rand(WC);document.getElementById("wild-text").textContent=text;}
  if(type==="affirm"){text=rand(AF);document.getElementById("affirm-text").textContent='"'+text+'"';}
  currentCards[type]=text;
  updateFavBtn(type);
}
function rollAll(){
  rolls++;totalRolls++;
  roll("practice");roll("content");roll("collab");roll("wild");roll("affirm");
  updateRollDisplay();
  fbSave("totalRolls",totalRolls);
}
function updateRollDisplay(){
  const sess=rolls+" this session";
  const total=totalRolls>rolls?" ¬∑ "+totalRolls+" all time":"";
  document.getElementById("roll-count").textContent=sess+total;
}

/* ===== FAVORITES ===== */
function isFaved(type){return favorites.some(f=>f.type===type&&f.text===currentCards[type]);}
function updateFavBtn(type){
  const btn=document.getElementById("fav-"+type);
  if(!btn)return;
  const saved=isFaved(type);
  btn.textContent=saved?"‚òÖ":"‚òÜ";
  btn.className="fav-btn"+(saved?" saved":"");
}
function toggleFav(type){
  const text=currentCards[type];
  if(!text)return;
  const idx=favorites.findIndex(f=>f.type===type&&f.text===text);
  if(idx>=0){favorites.splice(idx,1);}
  else{favorites.push({type,text});}
  updateFavBtn(type);
  renderFavs();
  fbSave("favorites",favorites);
}
function removeFav(i){
  const removed=favorites[i];
  favorites.splice(i,1);
  renderFavs();
  // Update card button if it matches current
  if(removed&&currentCards[removed.type]===removed.text)updateFavBtn(removed.type);
  fbSave("favorites",favorites);
}
let favsOpen=false;
function toggleFavsPanel(){
  favsOpen=!favsOpen;
  document.getElementById("favs-list").style.display=favsOpen?"flex":"none";
  document.getElementById("favs-arrow").className="arrow"+(favsOpen?" open":"");
}
function renderFavs(){
  const section=document.getElementById("favs-section");
  const list=document.getElementById("favs-list");
  const count=document.getElementById("favs-count");
  count.textContent=favorites.length;
  section.style.display=favorites.length>0?"block":"none";
  list.innerHTML="";
  favorites.forEach((f,i)=>{
    const item=document.createElement("div");item.className="fav-item";
    const badge=document.createElement("span");badge.className="fav-item-type";
    badge.style.color=TYPE_COLORS[f.type]||"var(--mut)";
    badge.style.background=(TYPE_COLORS[f.type]||"var(--mut)")+"15";
    badge.textContent=(TYPE_ICONS[f.type]||"")+" "+f.type;
    const text=document.createElement("span");text.className="fav-item-text";text.textContent=f.text;
    const del=document.createElement("button");del.className="fav-item-del";del.textContent="√ó";del.onclick=()=>removeFav(i);
    item.appendChild(badge);item.appendChild(text);item.appendChild(del);
    list.appendChild(item);
  });
}

function toggleGroove(){
  grooveOn=!grooveOn;
  const btn=document.getElementById("groove-toggle");
  btn.textContent=grooveOn?"üéµ Grooving...":"‚ñ∂ Activate";
  btn.className="groove-btn"+(grooveOn?" on":"");
}
const hr=new Date().getHours();
document.getElementById("greeting").textContent=
  (hr<12?"Rise and groove":hr<17?"Keep the groove alive":"Evening groove session")+
  ", Kaze ‚Äî "+new Date().toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"});
const canvas=document.getElementById("viz"),ctx=canvas.getContext("2d");
canvas.width=500;canvas.height=160;let t=0;
const colors=["#d4943a","#a78bfa","#22d3ee","#f472b6","#4ade80"];
function draw(){
  t+=grooveOn?0.03:0.005;
  ctx.fillStyle="rgba(8,7,13,0.15)";ctx.fillRect(0,0,500,160);
  for(let i=0;i<5;i++){
    ctx.beginPath();ctx.strokeStyle=colors[i];ctx.lineWidth=2;ctx.globalAlpha=0.6+Math.sin(t+i)*0.3;
    for(let x=0;x<500;x++){
      const f=0.015+i*0.005,a=(grooveOn?35:12)+Math.sin(t*0.5+i)*(grooveOn?18:4),
            p=t*(1+i*0.3)+i*1.2,y=80+Math.sin(x*f+p)*a+Math.sin(x*f*2.1+p*0.7)*a*0.3;
      x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.stroke();ctx.globalAlpha=1;
  }
  if(grooveOn){const p=Math.sin(t*4)*0.5+0.5;ctx.beginPath();ctx.arc(250,80,6+p*10,0,Math.PI*2);
    ctx.fillStyle="rgba(212,148,58,"+(0.3+p*0.4)+")";ctx.fill();}
  requestAnimationFrame(draw);
}
draw();

// Initial roll + Firebase load
rollAll();rolls=0;totalRolls=0;
document.getElementById("roll-count").textContent="Fresh oracle readings every tap";

(async()=>{
  try{
    const [savedFavs,savedRolls]=await Promise.all([fbLoad("favorites",[]),fbLoad("totalRolls",0)]);
    favorites=Array.isArray(savedFavs)?savedFavs:[];
    totalRolls=typeof savedRolls==="number"?savedRolls:0;
    renderFavs();
    ["practice","content","collab","wild"].forEach(updateFavBtn);
    updateRollDisplay();
  }catch(e){console.warn("Firebase init load failed",e);}

  onDataChange("favorites",val=>{favorites=Array.isArray(val)?val:[];renderFavs();["practice","content","collab","wild"].forEach(updateFavBtn);});
  onDataChange("totalRolls",val=>{if(typeof val==="number"){totalRolls=val;updateRollDisplay();}});
})();

if("serviceWorker"in navigator){const sw='self.addEventListener("install",e=>self.skipWaiting());self.addEventListener("activate",e=>self.clients.claim());';navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:"application/javascript"}))).catch(()=>{});}
</script>
</body>
</html>