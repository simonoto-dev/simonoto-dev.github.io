<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PoF Admin">
<meta name="theme-color" content="#0a0a0f">
<meta name="description" content="Professor of Funk ‚Äî Teacher Admin Dashboard">
<title>Professor of Funk ‚Äî Admin</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUHJvZiBvZiBGdW5rIEFkbWluIiwic2hvcnRfbmFtZSI6IlBvRiBBZG1pbiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGEwYTBmIiwidGhlbWVfY29sb3IiOiIjRDQ5NDNBIn0=">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0f; --surface:#13131a; --surface2:#1a1a24; --border:#2a2a35;
  --accent:#D4943A; --accent-glow:rgba(212,148,58,0.15); --accent-dim:#7A4A28;
  --green:#4ade80; --red:#f87171; --blue:#60a5fa; --purple:#c084fc; --yellow:#fbbf24;
  --text:#e8e8ef; --muted:#888899;
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans','Segoe UI',system-ui,sans-serif;font-size:14px;line-height:1.5;}
input,textarea,select,button{font-family:inherit;font-size:inherit;}
.app{display:flex;flex-direction:column;height:100vh;height:100dvh;padding-top:var(--safe-top);}
.header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 16px;display:flex;align-items:center;height:52px;flex-shrink:0;z-index:100;}
.logo{display:flex;align-items:center;gap:8px;margin-right:auto;}
.logo-icon{font-size:18px;}
.logo-name{font-family:'DM Serif Display',Georgia,serif;font-size:16px;font-weight:700;color:var(--accent);}
.logo-sub{color:var(--muted);font-size:10px;font-weight:500;display:none;}
@media(min-width:500px){.logo-sub{display:inline;}}
.header-logout{background:transparent;border:1px solid var(--border);border-radius:6px;padding:3px 8px;color:var(--muted);font-size:10px;cursor:pointer;}
.bottom-nav{display:flex;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;padding-bottom:var(--safe-bottom);z-index:100;}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 4px 6px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:9px;font-weight:500;transition:color 0.2s;}
.nav-btn.active{color:var(--accent);}
.nav-btn .nav-icon{font-size:18px;line-height:1;}
.content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}
.pad{padding:16px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:10px;}
.card-accent{border-top:3px solid var(--accent);}
.section-title{font-family:'DM Serif Display',Georgia,serif;font-size:20px;margin:0 0 4px;}
.section-sub{color:var(--muted);font-size:12px;margin:0 0 16px;}
.label{color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:6px;}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.3px;}
.badge-green{background:rgba(74,222,128,0.15);color:var(--green);}
.badge-yellow{background:rgba(251,191,36,0.15);color:var(--yellow);}
.badge-red{background:rgba(248,113,113,0.15);color:var(--red);}
.badge-blue{background:rgba(96,165,250,0.15);color:var(--blue);}
.badge-purple{background:rgba(192,132,252,0.15);color:var(--purple);}
.badge-accent{background:var(--accent-glow);color:var(--accent);}
.btn{background:var(--accent);color:#000;border:none;border-radius:8px;padding:8px 16px;font-weight:600;font-size:13px;cursor:pointer;transition:opacity 0.2s;}
.btn:hover{opacity:0.9;}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:5px 12px;font-size:12px;cursor:pointer;}
.btn-outline.active{border-color:var(--accent);color:var(--accent);background:var(--accent-glow);}
.input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);outline:none;font-size:14px;}
.input:focus{border-color:var(--accent);}
select.input{appearance:auto;}
.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;}
.stat-label{color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:0.5px;}
.stat-value{font-family:'DM Serif Display',Georgia,serif;font-size:24px;font-weight:700;color:var(--text);margin:2px 0;}
.stat-sub{color:var(--muted);font-size:11px;}
.student-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s;}
.student-card:hover{border-color:var(--accent);}
.student-name{font-family:'DM Serif Display',Georgia,serif;font-size:17px;margin-bottom:2px;}
.student-meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:11px;}
.student-detail{display:flex;align-items:center;gap:4px;}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.attendance-grid{display:grid;grid-template-columns:120px repeat(7,1fr);gap:1px;background:var(--border);border-radius:10px;overflow:hidden;margin-bottom:16px;font-size:12px;}
.attendance-cell{background:var(--surface);padding:8px 6px;text-align:center;display:flex;align-items:center;justify-content:center;}
.attendance-header{background:var(--surface2);font-weight:600;color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:0.3px;}
.attendance-name{justify-content:flex-start;font-weight:600;font-size:12px;}
.attendance-toggle{cursor:pointer;font-size:16px;transition:opacity 0.2s;}
.attendance-toggle:hover{opacity:0.8;}
.payment-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);}
.payment-row:last-child{border-bottom:none;}
.payment-amount{font-family:'DM Serif Display',Georgia,serif;font-size:16px;font-weight:700;}
.payment-positive{color:var(--green);}
.payment-negative{color:var(--red);}
.ensemble-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:10px;}
.ensemble-name{font-family:'DM Serif Display',Georgia,serif;font-size:17px;margin-bottom:4px;}
.repertoire-item{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);}
.repertoire-item:last-child{border-bottom:none;}
.form-group{margin-bottom:12px;}
.form-group label{display:block;color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:0.3px;font-weight:600;margin-bottom:4px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.revenue-bar{display:flex;align-items:flex-end;gap:4px;height:80px;margin:12px 0;}
.revenue-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;}
.revenue-fill{width:100%;border-radius:4px 4px 0 0;background:var(--accent);transition:height 0.3s;}
.revenue-label{font-size:9px;color:var(--muted);}
.revenue-amount{font-size:9px;font-weight:700;color:var(--accent);}
@media(min-width:700px){
  .stats{grid-template-columns:repeat(4,1fr);}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
}
@media(max-width:600px){
  .attendance-grid{grid-template-columns:80px repeat(7,1fr);font-size:10px;}
  .attendance-cell{padding:6px 3px;}
}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
</style>
</head>
<body>
<div id="auth-gate" style="display:flex;align-items:center;justify-content:center;height:100vh;background:#0a0a0f;">
<div style="text-align:center;padding:40px;">
<div style="font-size:48px;margin-bottom:12px;">üéõÔ∏è</div>
<div style="font-family:'DM Serif Display',Georgia,serif;font-size:26px;color:#D4943A;margin-bottom:4px;">Professor of Funk</div>
<div style="color:#888899;font-size:12px;margin-bottom:24px;">Admin Dashboard ‚Äî Teacher Access</div>
<input id="auth-pw" type="password" placeholder="Admin passphrase" style="width:260px;padding:10px 16px;border-radius:10px;border:1px solid #2a2a35;background:#13131a;color:#e8e8ef;font-size:14px;text-align:center;outline:none;" onkeydown="if(event.key==='Enter')checkAuth()">
<br><button onclick="checkAuth()" style="margin-top:12px;padding:8px 32px;border-radius:10px;border:none;background:#D4943A;color:#000;font-weight:600;font-size:14px;cursor:pointer;">Enter</button>
<div id="auth-err" style="color:#f87171;font-size:12px;margin-top:10px;display:none;">Invalid passphrase</div>
</div>
</div>
<div class="app" id="app" style="display:none;"></div>
<script>
/* ===== MOCK DATA ===== */
const MOCK = {
  students: {
    mason: {
      profile: { name: "Mason", instrument: "Guitar", program: "Private Lessons", startDate: "2024-09-10", accessCode: "mason1", parentName: "David & Sarah", parentEmail: "mason.parents@email.com", lessonDay: "Wednesday", lessonTime: "3:00 PM", rate: 200 },
      lastLesson: "2026-02-05",
      nextLesson: "2026-02-12",
      paymentStatus: "current",
      attendance: {
        "2026-02-05": { present: true }, "2026-01-29": { present: true }, "2026-01-22": { present: true },
        "2026-01-15": { present: false, cancelled: true, note: "Family vacation" }, "2026-01-08": { present: true }
      },
      billing: [
        { id: "b-m1", date: "2026-02-01", type: "charge", amount: 200, method: null, note: "February lessons" },
        { id: "b-m2", date: "2026-02-03", type: "payment", amount: 200, method: "Venmo", note: "@David-P" },
        { id: "b-m3", date: "2026-01-01", type: "charge", amount: 200, method: null, note: "January lessons" },
        { id: "b-m4", date: "2026-01-05", type: "payment", amount: 200, method: "Venmo", note: "@David-P" },
        { id: "b-m5", date: "2025-12-01", type: "charge", amount: 200, method: null, note: "December lessons" },
        { id: "b-m6", date: "2025-12-02", type: "payment", amount: 200, method: "Zelle", note: "sarah@email.com" }
      ]
    },
    micah: {
      profile: { name: "Micah", instrument: "Guitar", program: "Private Lessons", startDate: "2025-01-15", accessCode: "micah1", parentName: "Jennifer", parentEmail: "micah.parent@email.com", lessonDay: "Wednesday", lessonTime: "4:00 PM", rate: 200 },
      lastLesson: "2026-02-07",
      nextLesson: "2026-02-14",
      paymentStatus: "current",
      attendance: {
        "2026-02-07": { present: true }, "2026-01-31": { present: true }, "2026-01-24": { present: true },
        "2026-01-17": { present: true }, "2026-01-10": { present: false, cancelled: true, note: "Sick" }
      },
      billing: [
        { id: "b-mi1", date: "2026-02-01", type: "charge", amount: 200, method: null, note: "February lessons" },
        { id: "b-mi2", date: "2026-02-02", type: "payment", amount: 200, method: "Zelle", note: "jennifer@email.com" },
        { id: "b-mi3", date: "2026-01-01", type: "charge", amount: 200, method: null, note: "January lessons" },
        { id: "b-mi4", date: "2026-01-03", type: "payment", amount: 200, method: "Venmo", note: "@Jen-M" }
      ]
    },
    sienna: {
      profile: { name: "Sienna", instrument: "Guitar", program: "Private Lessons", startDate: "2025-06-01", accessCode: "sienna1", parentName: "Mark & Lisa", parentEmail: "sienna.parents@email.com", lessonDay: "Wednesday", lessonTime: "5:00 PM", rate: 200 },
      lastLesson: "2026-02-06",
      nextLesson: "2026-02-13",
      paymentStatus: "overdue",
      attendance: {
        "2026-02-06": { present: true }, "2026-01-30": { present: true }, "2026-01-23": { present: true },
        "2026-01-16": { present: true }, "2026-01-09": { present: true }
      },
      billing: [
        { id: "b-s1", date: "2026-02-01", type: "charge", amount: 200, method: null, note: "February lessons" },
        { id: "b-s2", date: "2026-01-01", type: "charge", amount: 200, method: null, note: "January lessons" },
        { id: "b-s3", date: "2026-01-15", type: "payment", amount: 200, method: "Venmo", note: "@Mark-L" }
      ]
    }
  },
  ensembles: {
    "new-advanced-groove": {
      info: { name: "New Advanced Groove Ensemble", schedule: "Sundays 2:00-4:30 PM", location: "Studio S, Oakland", members: ["Mason", "Kai", "Diego", "Ayla"] },
      repertoire: [
        { id: "rep1", title: "Superstition", artist: "Stevie Wonder", status: "performance-ready", notes: "All parts solid. Kai nailing the clavinet feel." },
        { id: "rep2", title: "Cissy Strut", artist: "The Meters", status: "performance-ready", notes: "Tight groove. Ready for any gig." },
        { id: "rep3", title: "Use Me", artist: "Bill Withers", status: "learning", notes: "Just started. Working on the groove pocket." },
        { id: "rep4", title: "Chameleon", artist: "Herbie Hancock", status: "learning", notes: "Intro section down. Need to learn the head." },
        { id: "rep5", title: "Pick Up the Pieces", artist: "Average White Band", status: "retired", notes: "Played at CJC showcase. Rotating out for now." }
      ]
    },
    "twin-peaks": {
      info: { name: "Twin Peaks Ensemble", schedule: "Sundays 12:00-1:30 PM", location: "Studio S, Oakland", members: ["Micah", "Sienna", "Olive", "Remy"] },
      repertoire: [
        { id: "rep6", title: "Stand By Me", artist: "Ben E. King", status: "performance-ready", notes: "Great dynamics. Sienna's arpeggio part is clean." },
        { id: "rep7", title: "Ain't No Sunshine", artist: "Bill Withers", status: "learning", notes: "Working on the 'I know' section transitions." },
        { id: "rep8", title: "Come Together", artist: "The Beatles", status: "learning", notes: "Bass line learning. Guitar riff needs work." },
        { id: "rep9", title: "Three Little Birds", artist: "Bob Marley", status: "performance-ready", notes: "Feel-good closer. Everyone sings on this." }
      ]
    }
  },
  lessonTranscripts: []
};

/* ===== AUTH ===== */
const AUTH_KEY = 'pof-admin-auth';
const ADMIN_HASH = '7f6def7b'; // passphrase: profunk-admin

function simpleHash(s) { let h = 0; for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; } return Math.abs(h).toString(16).slice(0, 8); }

function checkAuth() {
  const pw = document.getElementById('auth-pw').value;
  if (simpleHash(pw) === ADMIN_HASH) {
    sessionStorage.setItem(AUTH_KEY, '1');
    showApp();
  } else {
    document.getElementById('auth-err').style.display = 'block';
  }
}

function showApp() {
  document.getElementById('auth-gate').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  loadLocalData();
  render();
}

function logout() {
  sessionStorage.removeItem(AUTH_KEY);
  document.getElementById('auth-gate').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-pw').value = '';
  document.getElementById('auth-err').style.display = 'none';
}

if (sessionStorage.getItem(AUTH_KEY) === '1') showApp();

/* ===== LOCAL DATA ===== */
let localData = null;

function loadLocalData() {
  try {
    const saved = localStorage.getItem('pof-admin-data');
    localData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(MOCK));
  } catch (e) {
    localData = JSON.parse(JSON.stringify(MOCK));
  }
}

function saveLocalData() {
  try { localStorage.setItem('pof-admin-data', JSON.stringify(localData)); } catch (e) {}
}

/* ===== STATE ===== */
let currentTab = 0;
let selectedStudent = null;
let paymentStudent = null;

/* ===== HELPERS ===== */
function h(tag, attrs, ...children) {
  const el = document.createElement(tag);
  if (attrs) Object.entries(attrs).forEach(([k, v]) => {
    if (k === 'style' && typeof v === 'object') Object.assign(el.style, v);
    else if (k.startsWith('on')) el.addEventListener(k.slice(2).toLowerCase(), v);
    else if (k === 'class' || k === 'className') el.className = v;
    else if (k === 'html') el.innerHTML = v;
    else el.setAttribute(k, v);
  });
  children.flat(9).forEach(c => { if (c == null || c === false) return; el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
  return el;
}

function fmtDate(d) {
  if (!d) return '';
  return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function fmtDateFull(d) {
  if (!d) return '';
  return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function fmtCurrency(n) { return '$' + Math.abs(n).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }

function getBalance(studentKey) {
  const billing = localData.students[studentKey].billing || [];
  let balance = 0;
  billing.forEach(entry => {
    if (entry.type === 'charge') balance += entry.amount;
    else if (entry.type === 'payment') balance -= entry.amount;
  });
  return balance;
}

function getAttendanceRate(studentKey) {
  const att = localData.students[studentKey].attendance || {};
  const entries = Object.values(att);
  const attended = entries.filter(e => e.present).length;
  const total = entries.filter(e => !e.cancelled).length;
  return total ? Math.round(attended / total * 100) : 100;
}

function getStatusColor(status) {
  switch (status) {
    case 'current': return 'var(--green)';
    case 'overdue': return 'var(--red)';
    case 'overdue-lesson': return 'var(--yellow)';
    default: return 'var(--muted)';
  }
}

function getStatusBadge(status) {
  switch (status) {
    case 'current': return 'badge-green';
    case 'overdue': return 'badge-red';
    case 'overdue-lesson': return 'badge-yellow';
    default: return 'badge-blue';
  }
}

/* ===== VIEWS ===== */

function renderStudents() {
  const students = localData.students;
  const keys = Object.keys(students);
  const totalStudents = keys.length;
  const totalRevenue = keys.reduce((sum, k) => {
    const payments = students[k].billing.filter(b => b.type === 'payment');
    const thisMonth = payments.filter(b => {
      const d = new Date(b.date + 'T12:00:00');
      const now = new Date();
      return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });
    return sum + thisMonth.reduce((s, p) => s + p.amount, 0);
  }, 0);
  const outstanding = keys.reduce((sum, k) => sum + Math.max(0, getBalance(k)), 0);

  return h('div', { class: 'pad' },
    h('h2', { class: 'section-title' }, 'Students'),
    h('p', { class: 'section-sub' }, totalStudents + ' active students'),

    h('div', { class: 'stats' },
      h('div', { class: 'stat' }, h('div', { class: 'stat-label' }, 'Students'), h('div', { class: 'stat-value' }, '' + totalStudents)),
      h('div', { class: 'stat' }, h('div', { class: 'stat-label' }, 'This Month'), h('div', { class: 'stat-value' }, fmtCurrency(totalRevenue))),
      h('div', { class: 'stat' }, h('div', { class: 'stat-label' }, 'Outstanding'), h('div', { class: 'stat-value', style: { color: outstanding > 0 ? 'var(--red)' : 'var(--green)' } }, fmtCurrency(outstanding))),
      h('div', { class: 'stat' }, h('div', { class: 'stat-label' }, 'Rate'), h('div', { class: 'stat-value' }, '$200'), h('div', { class: 'stat-sub' }, '/month'))
    ),

    ...keys.map(key => {
      const s = students[key];
      const bal = getBalance(key);
      const attRate = getAttendanceRate(key);
      return h('div', { class: 'student-card', onClick: () => { selectedStudent = key; render(); } },
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
          h('div', {},
            h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
              h('div', { class: 'status-dot', style: { background: getStatusColor(s.paymentStatus) } }),
              h('div', { class: 'student-name' }, s.profile.name)
            ),
            h('div', { class: 'student-meta' },
              h('span', { class: 'student-detail' }, 'üé∏ ' + s.profile.instrument),
              h('span', { class: 'student-detail' }, 'üìÖ ' + s.profile.lessonDay + ' ' + s.profile.lessonTime),
              h('span', { class: 'student-detail' }, 'üë§ ' + s.profile.parentName)
            )
          ),
          h('span', { class: 'badge ' + getStatusBadge(s.paymentStatus) }, s.paymentStatus === 'current' ? 'Current' : s.paymentStatus === 'overdue' ? 'Balance Due' : 'Overdue')
        ),
        h('div', { style: { display: 'flex', gap: '16px', marginTop: '10px', fontSize: '11px', color: 'var(--muted)' } },
          h('span', {}, 'Last: ' + fmtDate(s.lastLesson)),
          h('span', {}, 'Next: ' + fmtDate(s.nextLesson)),
          h('span', {}, 'Attendance: ' + attRate + '%'),
          bal > 0 ? h('span', { style: { color: 'var(--red)', fontWeight: '600' } }, 'Owes: ' + fmtCurrency(bal)) : h('span', { style: { color: 'var(--green)' } }, 'Paid up')
        )
      );
    })
  );
}

function renderAttendance() {
  const students = localData.students;
  const keys = Object.keys(students);
  // Get last 4 weeks of dates (Wednesdays)
  const dates = [];
  const now = new Date();
  for (let i = 0; i < 7; i++) {
    const d = new Date(now);
    d.setDate(now.getDate() - (i * 7));
    dates.push(d.toISOString().slice(0, 10));
  }
  dates.reverse();

  return h('div', { class: 'pad' },
    h('h2', { class: 'section-title' }, 'Attendance'),
    h('p', { class: 'section-sub' }, 'Track lesson attendance'),

    h('div', { style: { overflowX: 'auto', marginBottom: '16px' } },
      h('div', { class: 'attendance-grid' },
        // Header row
        h('div', { class: 'attendance-cell attendance-header attendance-name' }, 'Student'),
        ...dates.map(d => h('div', { class: 'attendance-cell attendance-header' }, fmtDate(d))),

        // Student rows
        ...keys.flatMap(key => {
          const s = students[key];
          return [
            h('div', { class: 'attendance-cell attendance-name' }, s.profile.name),
            ...dates.map(d => {
              const att = s.attendance[d];
              let icon = '‚Äî';
              let color = 'var(--muted)';
              if (att) {
                if (att.present) { icon = '‚úì'; color = 'var(--green)'; }
                else if (att.cancelled) { icon = '‚úï'; color = 'var(--yellow)'; }
                else { icon = '‚úó'; color = 'var(--red)'; }
              }
              return h('div', {
                class: 'attendance-cell attendance-toggle',
                style: { color: color },
                onClick: () => {
                  if (!s.attendance[d]) {
                    s.attendance[d] = { present: true };
                  } else if (s.attendance[d].present) {
                    s.attendance[d] = { present: false, cancelled: false };
                  } else if (!s.attendance[d].cancelled) {
                    s.attendance[d] = { present: false, cancelled: true, note: 'Cancelled' };
                  } else {
                    delete s.attendance[d];
                  }
                  saveLocalData();
                  render();
                }
              }, icon);
            })
          ];
        })
      )
    ),

    h('div', { class: 'card' },
      h('div', { class: 'label' }, 'Legend'),
      h('div', { style: { display: 'flex', gap: '16px', fontSize: '12px' } },
        h('span', { style: { color: 'var(--green)' } }, '‚úì Present'),
        h('span', { style: { color: 'var(--red)' } }, '‚úó Absent'),
        h('span', { style: { color: 'var(--yellow)' } }, '‚úï Cancelled'),
        h('span', { style: { color: 'var(--muted)' } }, '‚Äî No lesson')
      ),
      h('p', { style: { color: 'var(--muted)', fontSize: '11px', marginTop: '6px' } }, 'Click to cycle: present ‚Üí absent ‚Üí cancelled ‚Üí clear')
    ),

    h('div', { class: 'card' },
      h('div', { class: 'label' }, 'Attendance Summary'),
      ...keys.map(key => {
        const s = students[key];
        const rate = getAttendanceRate(key);
        const entries = Object.values(s.attendance);
        const total = entries.filter(e => !e.cancelled).length;
        const attended = entries.filter(e => e.present).length;
        return h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 0', borderBottom: '1px solid var(--border)' } },
          h('span', { style: { fontWeight: '600', fontSize: '13px' } }, s.profile.name),
          h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
            h('span', { style: { fontSize: '11px', color: 'var(--muted)' } }, attended + '/' + total + ' lessons'),
            h('span', { style: { fontSize: '13px', fontWeight: '700', color: rate >= 80 ? 'var(--green)' : rate >= 60 ? 'var(--yellow)' : 'var(--red)' } }, rate + '%')
          )
        );
      })
    )
  );
}

function renderPayments() {
  const students = localData.students;
  const keys = Object.keys(students);

  if (paymentStudent) {
    const s = students[paymentStudent];
    const balance = getBalance(paymentStudent);
    const billing = (s.billing || []).sort((a, b) => new Date(b.date) - new Date(a.date));

    return h('div', { class: 'pad' },
      h('button', { class: 'btn-outline', style: { marginBottom: '12px' }, onClick: () => { paymentStudent = null; render(); } }, '‚Üê Back'),
      h('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' } },
        h('h2', { class: 'section-title' }, s.profile.name),
        h('span', { class: 'badge ' + (balance > 0 ? 'badge-red' : 'badge-green') }, balance > 0 ? 'Balance Due' : 'Paid Up')
      ),

      h('div', { class: 'stats' },
        h('div', { class: 'stat' }, h('div', { class: 'stat-label' }, 'Balance'), h('div', { class: 'stat-value', style: { color: balance > 0 ? 'var(--red)' : 'var(--green)' } }, (balance > 0 ? '' : '-') + fmtCurrency(balance))),
        h('div', { class: 'stat' }, h('div', { class: 'stat-label' }, 'Rate'), h('div', { class: 'stat-value' }, '$' + s.profile.rate), h('div', { class: 'stat-sub' }, '/month'))
      ),

      // Add payment form
      h('div', { class: 'card card-accent' },
        h('div', { style: { fontWeight: '600', fontSize: '13px', marginBottom: '10px' } }, 'Add Payment'),
        h('div', { class: 'form-row' },
          h('div', { class: 'form-group' },
            h('label', {}, 'Amount'),
            h('input', { class: 'input', id: 'pay-amount', type: 'number', placeholder: '200', value: '200' })
          ),
          h('div', { class: 'form-group' },
            h('label', {}, 'Method'),
            h('select', { class: 'input', id: 'pay-method' },
              h('option', { value: 'Venmo' }, 'Venmo'),
              h('option', { value: 'Zelle' }, 'Zelle'),
              h('option', { value: 'Cash' }, 'Cash'),
              h('option', { value: 'Check' }, 'Check'),
              h('option', { value: 'Other' }, 'Other')
            )
          )
        ),
        h('div', { class: 'form-group' },
          h('label', {}, 'Note'),
          h('input', { class: 'input', id: 'pay-note', placeholder: 'e.g. @username, check #, etc.' })
        ),
        h('button', { class: 'btn', onClick: () => {
          const amount = parseFloat(document.getElementById('pay-amount').value);
          const method = document.getElementById('pay-method').value;
          const note = document.getElementById('pay-note').value;
          if (!amount || amount <= 0) return;
          s.billing.push({ id: uid(), date: new Date().toISOString().slice(0, 10), type: 'payment', amount, method, note });
          if (getBalance(paymentStudent) <= 0) s.paymentStatus = 'current';
          saveLocalData();
          render();
        }}, 'Record Payment')
      ),

      // Transaction history
      h('div', { class: 'card' },
        h('div', { style: { fontWeight: '600', fontSize: '13px', marginBottom: '10px' } }, 'Transaction History'),
        ...billing.map(entry =>
          h('div', { class: 'payment-row' },
            h('div', { style: { width: '80px' } },
              h('span', { class: 'payment-amount ' + (entry.type === 'payment' ? 'payment-positive' : 'payment-negative') },
                (entry.type === 'payment' ? '+' : '-') + fmtCurrency(entry.amount)
              )
            ),
            h('div', { style: { flex: '1', minWidth: '0' } },
              h('div', { style: { fontSize: '12px' } }, entry.note || (entry.type === 'charge' ? 'Monthly charge' : 'Payment')),
              h('div', { style: { fontSize: '10px', color: 'var(--muted)' } },
                fmtDateFull(entry.date) + (entry.method ? ' ¬∑ ' + entry.method : ''))
            ),
            h('span', { class: 'badge ' + (entry.type === 'payment' ? 'badge-green' : 'badge-accent') }, entry.type)
          )
        )
      )
    );
  }

  // Monthly revenue calculation
  const now = new Date();
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const revenueByMonth = [];
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const month = d.getMonth();
    const year = d.getFullYear();
    let total = 0;
    keys.forEach(k => {
      students[k].billing.filter(b => b.type === 'payment').forEach(b => {
        const bd = new Date(b.date + 'T12:00:00');
        if (bd.getMonth() === month && bd.getFullYear() === year) total += b.amount;
      });
    });
    revenueByMonth.push({ label: monthNames[month], amount: total });
  }
  const maxRevenue = Math.max(...revenueByMonth.map(r => r.amount), 1);

  return h('div', { class: 'pad' },
    h('h2', { class: 'section-title' }, 'Payments'),
    h('p', { class: 'section-sub' }, 'Track payments and balances'),

    h('div', { class: 'card' },
      h('div', { style: { fontWeight: '600', fontSize: '13px', marginBottom: '8px' } }, 'Monthly Revenue'),
      h('div', { class: 'revenue-bar' },
        ...revenueByMonth.map(r =>
          h('div', { class: 'revenue-col' },
            h('div', { class: 'revenue-amount' }, r.amount > 0 ? fmtCurrency(r.amount) : ''),
            h('div', { class: 'revenue-fill', style: { height: Math.max(4, (r.amount / maxRevenue) * 60) + 'px' } }),
            h('div', { class: 'revenue-label' }, r.label)
          )
        )
      )
    ),

    ...keys.map(key => {
      const s = students[key];
      const balance = getBalance(key);
      return h('div', { class: 'student-card', onClick: () => { paymentStudent = key; render(); } },
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
          h('div', {},
            h('div', { class: 'student-name' }, s.profile.name),
            h('div', { style: { fontSize: '11px', color: 'var(--muted)' } }, s.profile.program + ' ¬∑ $' + s.profile.rate + '/mo')
          ),
          h('div', { style: { textAlign: 'right' } },
            h('div', { style: { fontFamily: "'DM Serif Display',Georgia,serif", fontSize: '20px', fontWeight: '700', color: balance > 0 ? 'var(--red)' : 'var(--green)' } }, (balance > 0 ? '' : '') + fmtCurrency(balance)),
            h('span', { class: 'badge ' + (balance > 0 ? 'badge-red' : 'badge-green') }, balance > 0 ? 'Due' : 'Paid')
          )
        )
      );
    })
  );
}

function renderLessonInput() {
  const students = localData.students;
  const keys = Object.keys(students);

  return h('div', { class: 'pad' },
    h('h2', { class: 'section-title' }, 'Lesson Input'),
    h('p', { class: 'section-sub' }, 'Paste a lesson transcript for AI processing (coming soon)'),

    h('div', { class: 'card card-accent' },
      h('div', { class: 'form-group' },
        h('label', {}, 'Student'),
        h('select', { class: 'input', id: 'lesson-student' },
          h('option', { value: '' }, 'Select student...'),
          ...keys.map(k => h('option', { value: k }, students[k].profile.name))
        )
      ),
      h('div', { class: 'form-group' },
        h('label', {}, 'Lesson Date'),
        h('input', { class: 'input', id: 'lesson-date', type: 'date', value: new Date().toISOString().slice(0, 10) })
      ),
      h('div', { class: 'form-group' },
        h('label', {}, 'Transcript / Notes'),
        h('textarea', { class: 'input', id: 'lesson-transcript', rows: '10', placeholder: 'Paste lesson transcript here, or write quick notes about what was covered...\n\nIn the future, this will be processed by AI to automatically generate:\n- Lesson summary\n- Key concepts\n- Practice plan\n- Milestone updates', style: { resize: 'vertical', fontFamily: "'IBM Plex Sans', monospace", fontSize: '13px', lineHeight: '1.6' } })
      ),
      h('button', { class: 'btn', onClick: () => {
        const studentKey = document.getElementById('lesson-student').value;
        const date = document.getElementById('lesson-date').value;
        const transcript = document.getElementById('lesson-transcript').value.trim();
        if (!studentKey || !transcript) { alert('Please select a student and enter notes.'); return; }

        // For now, save raw transcript to mock data
        if (!localData.lessonTranscripts) localData.lessonTranscripts = [];
        localData.lessonTranscripts.push({
          id: uid(),
          studentKey,
          date,
          transcript,
          processed: false,
          savedAt: new Date().toISOString()
        });
        saveLocalData();

        // Clear form
        document.getElementById('lesson-transcript').value = '';
        alert('Transcript saved! AI processing will be available in a future update.');
      }}, 'Save Transcript'),
      h('p', { style: { color: 'var(--muted)', fontSize: '11px', marginTop: '8px', fontStyle: 'italic' } }, 'AI processing coming soon ‚Äî for now, transcripts are saved locally.')
    ),

    // Recent transcripts
    localData.lessonTranscripts && localData.lessonTranscripts.length > 0 ? h('div', {},
      h('div', { class: 'label', style: { marginTop: '16px' } }, 'Saved Transcripts'),
      ...localData.lessonTranscripts.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt)).map(t => {
        const s = students[t.studentKey];
        return h('div', { class: 'card' },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' } },
            h('div', {},
              h('span', { style: { fontWeight: '600', fontSize: '13px' } }, s ? s.profile.name : 'Unknown'),
              h('span', { style: { color: 'var(--muted)', fontSize: '11px', marginLeft: '8px' } }, fmtDateFull(t.date))
            ),
            h('span', { class: 'badge ' + (t.processed ? 'badge-green' : 'badge-yellow') }, t.processed ? 'Processed' : 'Pending')
          ),
          h('p', { style: { fontSize: '12px', color: 'var(--muted)', lineHeight: '1.4', maxHeight: '60px', overflow: 'hidden' } }, t.transcript)
        );
      })
    ) : ''
  );
}

function renderEnsembles() {
  const ensembles = localData.ensembles;
  const statusColors = {
    'performance-ready': { badge: 'badge-green', label: 'Performance Ready' },
    'learning': { badge: 'badge-blue', label: 'Learning' },
    'retired': { badge: 'badge-purple', label: 'Retired' }
  };

  return h('div', { class: 'pad' },
    h('h2', { class: 'section-title' }, 'Ensembles'),
    h('p', { class: 'section-sub' }, Object.keys(ensembles).length + ' active ensembles'),

    ...Object.entries(ensembles).map(([key, ens]) => {
      const rep = ens.repertoire || [];
      const ready = rep.filter(r => r.status === 'performance-ready').length;
      const learning = rep.filter(r => r.status === 'learning').length;

      return h('div', { class: 'ensemble-card' },
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' } },
          h('div', {},
            h('div', { class: 'ensemble-name' }, ens.info.name),
            h('div', { style: { fontSize: '11px', color: 'var(--muted)' } }, ens.info.schedule + ' ¬∑ ' + ens.info.location)
          ),
          h('span', { class: 'badge badge-accent' }, rep.length + ' songs')
        ),

        h('div', { style: { marginBottom: '10px' } },
          h('div', { class: 'label' }, 'Members'),
          h('div', { style: { display: 'flex', gap: '6px', flexWrap: 'wrap' } },
            ...ens.info.members.map(m =>
              h('span', { style: { padding: '2px 10px', borderRadius: '10px', fontSize: '11px', background: 'var(--surface2)', border: '1px solid var(--border)', color: 'var(--text)' } }, m)
            )
          )
        ),

        h('div', { style: { display: 'flex', gap: '12px', marginBottom: '10px', fontSize: '11px' } },
          h('span', { style: { color: 'var(--green)' } }, ready + ' ready'),
          h('span', { style: { color: 'var(--blue)' } }, learning + ' learning'),
          rep.filter(r => r.status === 'retired').length > 0 ? h('span', { style: { color: 'var(--purple)' } }, rep.filter(r => r.status === 'retired').length + ' retired') : ''
        ),

        h('div', {},
          h('div', { class: 'label' }, 'Repertoire'),
          ...rep.map(song =>
            h('div', { class: 'repertoire-item' },
              h('div', { style: { minWidth: '0' } },
                h('div', { style: { fontSize: '13px', fontWeight: '600' } }, song.title),
                h('div', { style: { fontSize: '11px', color: 'var(--muted)' } }, song.artist + (song.notes ? ' ‚Äî ' + song.notes : ''))
              ),
              h('span', { class: 'badge ' + statusColors[song.status].badge }, statusColors[song.status].label)
            )
          )
        )
      );
    })
  );
}

/* ===== RENDER ===== */
function render() {
  const app = document.getElementById('app');
  app.innerHTML = '';
  const tabs = [
    { icon: 'üë•', label: 'Students' },
    { icon: 'üìÖ', label: 'Attendance' },
    { icon: 'üí∞', label: 'Payments' },
    { icon: 'üìù', label: 'Lessons' },
    { icon: 'üéµ', label: 'Ensembles' }
  ];

  // Header
  app.appendChild(h('div', { class: 'header' },
    h('div', { class: 'logo' },
      h('span', { class: 'logo-icon' }, 'üéõÔ∏è'),
      h('span', { class: 'logo-name' }, 'PROF OF FUNK'),
      h('span', { class: 'logo-sub' }, 'ADMIN')
    ),
    h('button', { class: 'header-logout', onClick: logout }, 'Sign Out')
  ));

  // Content
  const content = h('div', { class: 'content' });
  switch (currentTab) {
    case 0: content.appendChild(renderStudents()); break;
    case 1: content.appendChild(renderAttendance()); break;
    case 2: content.appendChild(renderPayments()); break;
    case 3: content.appendChild(renderLessonInput()); break;
    case 4: content.appendChild(renderEnsembles()); break;
  }
  app.appendChild(content);

  // Bottom nav
  app.appendChild(h('div', { class: 'bottom-nav' },
    ...tabs.map((t, i) => h('button', {
      class: 'nav-btn' + (currentTab === i ? ' active' : ''),
      onClick: () => { currentTab = i; selectedStudent = null; paymentStudent = null; render(); }
    },
      h('span', { class: 'nav-icon' }, t.icon),
      t.label
    ))
  ));
}

/* ===== SERVICE WORKER ===== */
if ('serviceWorker' in navigator) {
  const sw = `self.addEventListener("install",e=>self.skipWaiting());self.addEventListener("activate",e=>self.clients.claim());self.addEventListener("fetch",e=>e.respondWith(fetch(e.request).catch(()=>new Response("Offline",{status:503}))));`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], { type: 'application/javascript' }))).catch(() => {});
}
</script>
</body>
</html>